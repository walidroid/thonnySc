name: Test Portable Setup

on:
  push:
    branches:
      - "**"
  pull_request:
  workflow_dispatch:

jobs:
  test-portable-launch:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Test import (non-GUI)
        run: |
          python -c "import sys; sys.path.insert(0, '.'); import thonny; print(f'Thonny version: {thonny.get_version()}')"
      
      - name: Validate launch script exists
        run: |
          python -c "import os; assert os.path.exists('launch_thonny.py'), 'launch_thonny.py not found'"
      
      - name: Test launch script syntax
        run: |
          python -m py_compile launch_thonny.py
      
      - name: Validate portable fixes
        shell: bash
        run: |
          python - <<'PYEOF'
          import sys, os
          sys.path.insert(0, '.')
          with open('thonny/__init__.py', 'r') as f:
              content = f.read()
              assert 'SINGLE_INSTANCE_DEFAULT = True' in content, 'Single instance mode not enabled'
              print('Single instance mode enabled')
          with open('thonny/editors.py', 'r') as f:
              content = f.read()
              assert 'os.path.isfile(filename)' in content, 'File check not using isfile()'
              print('File loading uses isfile() check')
          print('All portable fixes validated')
          PYEOF
      
      - name: Check Tcl/Tk auto-detection in launch script
        shell: bash
        run: |
          python - <<'PYEOF'
          with open('launch_thonny.py', 'r') as f:
              content = f.read()
              assert 'setup_tcl_tk' in content, 'Tcl/Tk auto-detection not found'
              assert 'TCL_LIBRARY' in content, 'Tcl/Tk configuration not found'
              print('Tcl/Tk auto-detection present in launch script')
          PYEOF

  test-shell-scripts:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make shell script executable
        run: chmod +x run_thonny.sh
      
      - name: Validate shell script syntax
        run: bash -n run_thonny.sh
      
      - name: Check script can find launch_thonny.py
        run: |
          bash -c '
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          test -f "$SCRIPT_DIR/launch_thonny.py" && echo "âœ“ launch_thonny.py found"
          '
