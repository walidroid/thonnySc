name: Build Installer
on:
  push:
    branches:
      - "**"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install PyInstaller
        run: pip install pyinstaller
      - name: Install Inno Setup
        shell: powershell
        run: choco install innosetup -y
      - name: Generate Version
        id: version
        shell: powershell
        run: |
          $date = Get-Date -Format "yyyy.MM.dd"
          $runNumber = $env:GITHUB_RUN_NUMBER
          $version = "${date}.${runNumber}"
          Write-Host "Generated version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT
      - name: Build
        shell: powershell
        run: |
          $env:CI = "true"
          $version = "${{ steps.version.outputs.version }}"
          pwsh -NoProfile -ExecutionPolicy Bypass -File build.ps1 -Version $version
      - name: Show Installed Packages
        shell: powershell
        run: |
          & ".\Python\python.exe" -m pip list
          Get-ChildItem -Path ".\Python\Lib\site-packages" | Select-Object -First 50 | ForEach-Object { $_.Name }
      - name: Validate Bundled Dependencies
        shell: powershell
        run: |
          $mods = @('numpy','esptool','serial','friendly_traceback','asttokens','packaging','minny','pylint','mypy','wheel','send2trash')
          foreach ($m in $mods) {
            & ".\Python\python.exe" -c "import $m; print('$m OK')" | Out-Host
          }
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: ThonnySc-installer-${{ steps.version.outputs.version }}
          path: |
            output\ThonnySc_v${{ steps.version.outputs.version }}.exe
            dist\Thonny\**
          if-no-files-found: warn
